#!/usr/bin/env node

/**
 * Build script for nwep Node.js bindings
 * Automatically detects the current platform and builds the native addon
 * Handles both workspace (development) and standalone (npm install) scenarios
 */

const { execSync } = require('child_process')
const { platform, arch } = require('os')
const path = require('path')
const fs = require('fs')

function log(message) {
  console.log(`[nwep-build] ${message}`)
}

function formatBytes(bytes) {
  if (bytes === 0) return '0 bytes'
  const k = 1024
  const sizes = ['bytes', 'kb', 'mb', 'gb']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i]
}

function getDirectorySize(dirPath) {
  let totalSize = 0

  function calculateSize(currentPath) {
    const stats = fs.statSync(currentPath)

    if (stats.isFile()) {
      totalSize += stats.size
    } else if (stats.isDirectory()) {
      const files = fs.readdirSync(currentPath)
      files.forEach(file => {
        calculateSize(path.join(currentPath, file))
      })
    }
  }

  try {
    calculateSize(dirPath)
  } catch (error) {
    return 0
  }

  return totalSize
}

function checkRustInstalled() {
  try {
    const version = execSync('rustc --version', { encoding: 'utf-8' })
    log(`rust: ${version.trim()}`)
    return true
  } catch (error) {
    return false
  }
}

function isInWorkspace(packageDir) {
  // Check if ../quiche exists (we're in the main quiche-nwep workspace)
  const quichePath = path.join(packageDir, '../quiche')
  return fs.existsSync(quichePath)
}

function setupStandaloneWorkspace(packageDir) {
  const parentDir = path.join(packageDir, '..')
  const parentCargoToml = path.join(parentDir, 'Cargo.toml')
  const workspaceTemplate = path.join(packageDir, 'Cargo.workspace.toml')

  // Check if parent Cargo.toml already exists
  if (fs.existsSync(parentCargoToml)) {
    // Check if it's our workspace file or the main workspace
    const content = fs.readFileSync(parentCargoToml, 'utf-8')
    if (content.includes('quiche-nwep workspace') || content.includes('[workspace]')) {
      return null // Already set up
    }
  }

  // Copy workspace template to parent directory
  if (!fs.existsSync(workspaceTemplate)) {
    throw new Error('Cargo.workspace.toml template not found!')
  }

  fs.copyFileSync(workspaceTemplate, parentCargoToml)
  log('created temp workspace config')
  return parentCargoToml
}

function cleanupStandaloneWorkspace(workspaceFile) {
  if (workspaceFile && fs.existsSync(workspaceFile)) {
    try {
      fs.unlinkSync(workspaceFile)
    } catch (error) {
      // ignore cleanup failures
    }
  }
}

function main() {
  log('building from source for your platform')

  if (!checkRustInstalled()) {
    console.error('[nwep] rust not found. install from https://rustup.rs/')
    console.error('[nwep] then run: npm rebuild @webprotocol/nwep')
    process.exit(1)
  }

  const packageDir = path.join(__dirname, '..')
  const inWorkspace = isInWorkspace(packageDir)
  let workspaceFile = null

  try {
    if (inWorkspace) {
      log('mode: workspace dev')
    } else {
      log('mode: standalone install')

      // Check if vendor directory exists
      const vendorDir = path.join(packageDir, 'vendor')
      if (!fs.existsSync(vendorDir)) {
        console.error('[nwep] vendor dir missing, bad package publish')
        process.exit(1)
      }

      const vendorSize = getDirectorySize(vendorDir)
      log(`vendored deps: ${formatBytes(vendorSize)}`)

      // Setup standalone workspace
      workspaceFile = setupStandaloneWorkspace(packageDir)
    }

    const platformName = platform()
    const archName = arch()
    log(`target: ${platformName}-${archName}`)

    const buildCommand = 'napi build --platform --release'
    log('compiling... (this might take a minute)')
    console.log() // Empty line before build output

    const startTime = Date.now()

    execSync(buildCommand, {
      stdio: 'inherit',
      cwd: packageDir
    })

    const buildTime = ((Date.now() - startTime) / 1000).toFixed(1)

    console.log() // Empty line after build output
    log(`done in ${buildTime}s`)

    // Clean up vendor directory after successful build to save space
    if (!inWorkspace) {
      const vendorDir = path.join(packageDir, 'vendor')
      if (fs.existsSync(vendorDir)) {
        const vendorSize = getDirectorySize(vendorDir)
        log(`cleaning up ${formatBytes(vendorSize)} of vendored deps`)

        fs.rmSync(vendorDir, { recursive: true, force: true })
        log(`freed ${formatBytes(vendorSize)}`)
      }

      if (workspaceFile) {
        cleanupStandaloneWorkspace(workspaceFile)
        log('removed temp workspace config')
      }
    }

    // Find the .node file
    const nodeFiles = fs.readdirSync(packageDir).filter(f => f.endsWith('.node'))
    if (nodeFiles.length > 0) {
      const nodeFile = nodeFiles[0]
      const nodeFileSize = fs.statSync(path.join(packageDir, nodeFile)).size
      log(`native addon: ${nodeFile} (${formatBytes(nodeFileSize)})`)
    }

    log('ready to use')

  } catch (error) {
    console.error(`[nwep] build failed: ${error.message}`)
    cleanupStandaloneWorkspace(workspaceFile)
    process.exit(1)
  }
}

main()
